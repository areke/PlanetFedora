<!DOCTYPE html> 
<html> 
<head> 
    <title>My Page</title> 
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="stylesheet" href="css/jquery.mobile-1.2.0.min.css" />
    <link rel="stylesheet" href="css/index.css" />
    <script type="text/javascript" src="js/jquery-1.8.2.min.js"></script>
    <script type="text/javascript">$(document).bind("mobileinit", function () {  $.mobile.defaultPageTransition = "none"; });</script>
    <script type="text/javascript" src="js/jquery.mobile-1.2.0.min.js"></script>
    <script src="cordova-2.2.0.js"></script>
    <script src ="childbrowser.js"></script>
    <script src ="share.js"></script>
</head> 
<body> 

<div data-role="page" id = "Homepage">

    <div data-role="header" data-theme="b" data-tap-toggle="false" height:"50px;">
        <h1 style = "font-size: 23px; white-space: normal;">Planet Fedora</h1>
    </div>

    <div data-role="content">   
        <ul id = "list" data-role="listview" data-icon="arrow-r" data-inset="true" data-filter="false" data-theme="d" style="white-space: normal">

        </ul> 
    </div>

</div>

<div data-role="page" id="DisplayPage">
    <div data-role="header" data-theme="b" style = "white-space: normal;">
        <h1 style = "font-size: 23px; white-space: normal; margin-left: auto; margin-right: auto; width: 300px;" id = "titleText"></h1>
    </div>

    <div data-role="content" id = "article" style = "overflow: auto;">
    </div>

    <div data-role="footer" data-theme="b" data-position="fixed" style = "text-align:center; height: 50px;">
        <a href="#mainPage" data-rel="back" id = "back" data-transition="slide" style = "font-size: 14px; float: left; margin-top: 10px; margin-left: 10px;">Back</a>
        <a href="#share" id = "share" data-transition="slide" style = "font-size: 14px; float: right; margin-top: 10px; margin-right: 10px;">Share</a>
    </div>
</div>
<script type = "text/javascript">
    $(document).ready(function() {
        var selectedEntry = "";
        var feed = "http://planet.fedoraproject.org/rss20.xml";
        xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET",feed,false); 
        xmlhttp.send();
        xmlDoc = xmlhttp.responseXML; //Get the xml
        items = xmlDoc.getElementsByTagName("item"); //Get each item individually
        var list = "";
        for (i = 0; i < items.length; i++) { 
                var des = (items[i].getElementsByTagName("title")[0].childNodes[0].nodeValue);
                var index = des.indexOf(": ");
                var splits = [des.slice(0,index), des.slice(index+2)]; //Seperate the author from the title
                var author = splits[0];
                var title = splits[1];
                var date = (items[i].getElementsByTagName("pubDate")[0].childNodes[0].nodeValue).split(" +0000")[0];
                var description = items[i].getElementsByTagName("description")[0].childNodes[0].nodeValue;
                var i1 = (items[i].getElementsByTagName("description")[0].childNodes[0].nodeValue).indexOf("<img");
                var i2 = (items[i].getElementsByTagName("description")[0].childNodes[0].nodeValue).indexOf(';">');
                var img = description.slice(i1,i2)+';">';
                list += '<li class="contentLink" style = "height: 160px"; text-align:center;><a href="#" data-transition="slide" class="contentLink" style = "font-size: 16px; text-decoration: none; color: black; white-space: normal;" data-entryid="'+i+'">' + img + title + '<h3>By: ' + author + '</h3><p>' + date + '</p><br></a></li>'; //Create the list
            }

        $("#list").append(list);
        $("#list").listview("refresh");

        $(".contentLink").bind("click", function() { //Capture link click
            $("#article").empty();
            selected = $(this).data("entryid");
            if (typeof selected !== "undefined") { //Check if everything is okay
                selectedEntry = selected;
            }
            window.location = "#DisplayPage"; //View the content
        });


        $("#DisplayPage").bind("pagebeforeshow", function(prepage) {
            var des = (items[selectedEntry].getElementsByTagName("title")[0].childNodes[0].nodeValue) //get title name
            var index = des.indexOf(": "); //Split 
            var splits = [des.slice(0,index), des.slice(index+2)];
            var title = splits[1]
            document.getElementById("titleText").innerHTML = title; //Set title
            content = items[selectedEntry].getElementsByTagName("description")[0].childNodes[0].nodeValue; //  
            $("#article").append(content); //Preload content

            $("a").click(function(event) {
                event.preventDefault(); //Stop links from opening
                href = this.href; //Get link from the link that was clicked
                if ((href != "file:///android_asset/www/index.html#mainPage") && (href != "file:///android_asset/www/index.html#") && (href != "file:///android_asset/www/index.html#share")) { //Make sure none of these links were clicked
                    window.plugins.childBrowser.showWebPage(href, { showLocationBar: true }); //Open the link in a childbrowser in order to prevent glitches as well as to make it easier to get back to using the app
                }
            });
            $("#share").click(function() {
                window.plugins.share.show({ //Let the user able to share the article easily
                    subject: 'Article on Fedora Planet',
                    text: 'Here is a cool article I found on Fedora Planet:\n'   + items[selectedEntry].getElementsByTagName("link")[0].childNodes[0].nodeValue},
                    function() {}, // Success function
                    function() {alert('Share failed')} // Failure function
                );
            });
        });

    });

</script>
</body>
</html>